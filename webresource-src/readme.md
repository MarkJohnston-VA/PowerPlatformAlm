# Using TypeScript for Web Resources in Dataverse

This project contains a working solution for using TypeScript to build Web Resources for use in Dataverse. This includes local debugging using VS Code (or the browser's DevTools) and unit testing.

## Disclaimers

- This project was extracted from a specific system (UMT). Although it was intended to be a generic solution that any system could use, there will inevitably be details (settings, naming conventions, configurations) that need to be modified to work with other systems. Your mileage may vary!
- The dependencies used by this project may change over time (such as [mkcert](https://github.com/FiloSottile/mkcert), [Webpack](https://webpack.js.org) or the [Dataverse DevTools Extension](https://marketplace.visualstudio.com/items?itemName=danish-naglekar.dataverse-devtools)). The general concepts should be stable and long-lasting, but some of the details may need to be adjusted as these dependencies change over time (or become deprecated).
- Each system will have different requirements. These differences could result in non-trivial changes to parts of this template project. This is to be expected! Perhaps the best outcome would be to share any enhancements with the Architect team to see if they could be incorporated back into the template to improve the overall starting point for other (future) systems.

# Prerequisites for Debugging

Debugging the TypeScript code locally depends on the following prerequisites:
1. Generate locally-trusted development Certificate and Key file using [mkcert](https://github.com/FiloSottile/mkcert)
    1. Install **mkcert** using the instructions [here](https://github.com/FiloSottile/mkcert?tab=readme-ov-file#windows)
    1. Run the following commands (assuming the current path is your User Profile folder):
        ```
        mkcert -install
        mkcert localhost 127.0.0.1
        ```
        This installs the certificate in your Trusted Root Certification Authorities Certificates folder, so that any site you host locally using this certificate will be considered secure by your browser.

    1. Make note of the generated *.pem* files; these will be needed in the following step.
1. OPTIONAL: Install and VS Code [Dataverse DevTools Extension](https://marketplace.visualstudio.com/items?itemName=danish-naglekar.dataverse-devtools) and connect the desired Dataverse environment. Refer to the project's [GitHub page](https://github.com/Power-Maverick/DataverseDevTools-VSCode?tab=readme-ov-file#generate-typings) for specific details.

# Add Code

1. Generate Typings for the desired Form using [Dataverse DevTools](https://marketplace.visualstudio.com/items?itemName=danish-naglekar.dataverse-devtools) extension.
    1. Connect to the desired Dataverse instance in the Connections panel.
    1. Locate the desired Entity (Table) in the Entities panel.
    1. Right-click the desired Entity (Table) and *Generate Typing*. **Select the `typings` folder as the path for the generated typings file.**
    1. Refer to the project's [GitHub page](https://github.com/Power-Maverick/DataverseDevTools-VSCode?tab=readme-ov-file#generate-typings) for specific details.
1. Create a new TypeScript form subclass.
    1. Add a new TypeScript file to the `src/forms` folder.
    1. Use the following as a template for your new class:
      ```ts
      import { BaseFormTyped } from "./BaseFormTyped";

      export namespace YourNamespace {
          //IMPORTANT: Do not name your class with the same name that is generated by the Typings!
          // For example, for the Account table/entity, you may use `AccountForm` as the class name
          // since the typings will be generated with the name `Account`.
          export class YourFormName extends BaseFormTyped<Xrm.YourTypingTypeName> {
              public async OnLoad(eventContext: Xrm.Events.EventContext): Promise<void> {
                  super.OnLoad(eventContext);
                  //Write your code here
              }
          }
      }

      window.YourNamespace.Forms.YourFormName = window.YourNamespace.Forms.YourFormName || new YourNamespace.YourFormName();
      ```

# Configure the Web Resource and Form in Dataverse.

  1. Add a new Web Resource with the following configurations:
      - Code: `//Coming soon...` (After your code is working, you can upload a stable copy of the JS file. For getting started, this can be anything, since you'll override it when debugging locally.)
      - File type: **Javascript (JS)**
      - Name: **vrm_YourNewFileNameEndingInJs.js** (Example: `vrm_AutomationBulkUserRequest.js`)
      - Display Name: **Your File's Name With No Extension** (Example: `AutomationBulkUserRequest`)
      - Description: **Anything or nothing**
      - Language: **None**
  1. Add the Web Resource to a Form and connect the Event Handlers.
      1. In the Form Editor, select *Form libraries*. Add the previously added Web Resource as a library to this form.
      1. In the Form's Events, add a new Event Handler for the *On Load* event with the following options:
          - Event Type: **On Load** (or any other event)
          - Library: (Previously added Web Resource)
          - Function: **YourNamespace.Forms.YourFormName.OnLoad** (For example: `VRM.Forms.AutomationBulkUserRequest.OnLoad`)
          - Enabled: (Checked)
          - Pass execution context as first parameter: (Checked)
  1. Save and Publish.
  1. Locate the Web Resource ID
      1. Load the form/screen in a browser while viewing the Network tool in the browser's DevTools.
      1. Note the full URL of the Web Resource. The ID is the URL Encoded part between the host name and the `webresources` folder. For example: `%7b000000013055978%7d`

# Configure Your Browser For Local Debugging

Note: For the purpose of these instructions, it is assumed that you'll be working with Microsoft Edge as your primary browser. Google Chrome can also be used, with one small change. Update the `type` attribute in the Launch Configuration (located in the VS Code Workspace file). Use the following choices:
  - Microsoft Edge: `msedge`
  - Google Chrome: `chrome`

  1. Open your browser and launch the DevTools (F12).
  1. Navigate to the Dataverse URL that you will be using to debug.
  1. Select the Sources tool and open the Overrides panel. Click *Select folder for overrides* and select a local folder where the browser content will be stored. Update the **BROWSER_OVERRIDE_CONTENT_ROOT** value in the `.env` file from the previous step with this folder path (using forward slashes instead of back slashes as the folder delimter).
  1. Select the Application tool and select *Application > Service workers* on the left. In the panel on the right, check the **Bypass for network** checkbox. This forces the [Service Worker](https://developer.chrome.com/docs/workbox/service-worker-overview) to re-fetch resources rather than depending on cached copies.

# Configure the Project

1. Create a [Dotenv](https://github.com/motdotla/dotenv) file named `.env` in the root of this project (same folder as *package.json*). This is a per-user file that contains values unique to each user's local system. Add following key/value pair items to this file:
    - BROWSER_OVERRIDE_CONTENT_ROOT - Local path you have selected for your Browser's Local Overrides, using forward slashes. (Example: `C:/TEMP/BrowserOverrides`)
    - KEY_FILE_NAME - Name of the Key File generated by **mkcert** (*SomeName-key.pem*)
    - CERT_FILE_NAME - Name of the Cert File generated by **mkcert** (*SomeName.pem*)

    Example `.env` file:
    ```
    BROWSER_OVERRIDE_CONTENT_ROOT=C:/TEMP/LocalOverrides
    KEY_FILE_NAME=localhost+1-key.pem
    CERT_FILE_NAME=localhost+2.pem
    ```
    This **.env** file will be used by the build and debug processes.
    
    **IMPORTANT: DO NOT COMMIT the .env FILE TO SOURCE CONTROL! (This file has been added to the .gitignore on purpose.)**
1. Configure the `webresources.json`
    1. In the `webresources.json` file, add an object for each Web Resource with the following values  to the *webResources* array:
      - sourceFile - relative local path to the TypeScript source file. For example, `./src/forms/AutomatBulkUserRequest.ts`
      - resourceName - The name given to the Web Resource in Dataverse. For example, `vrm_AutomationBulkUserRequest.js`. Note: This can include the file extension (.js) but does not necessarily need to.
      - resourceId - The URL Encoded Resource Id added to the path of the Web Resource by Dataverse. (For example, `%257b000000013055978%257d`).
      The build process uses the items defined in this file as the sources and targets. If a file is not being produced by the build, verify that the relevant details have been added to `webresources.json`.

1. Configure the Task and Launch Settings (in the code-workspace file)
    1. In the `client-scripting.code-workspace` file, update the following two values with the URL of the system you'll be debugging:
        - **task.options.env.DYNAMICS_URL** - Use the host name only (no *https://*). For example, `dvagov-dpass-dev.crm9.dynamics.com`.
        - **launch.configurations[DebugWithEdge].url** - Use the full URL here. For example, `https://dvagov-dpass-dev.crm9.dynamics.com`. (You could even set a more specific URL with appId and any other desired path or parameters).    
        
        Note: It would be ideal to have the URL in only one location but a solution was not available in the initial timebox.

# Run and Debug

1. Start the Debugger and Configure Local Overrides
    1. Install dependencies by running `npm install` in a terminal.
    1. Start the Debugger by opening the Run and Debug tab in VS Code, selecting the appropriate configuration (initially called, **DebugWithEdge-AllProcesses**), and starting the Debugger (F5).
    *Note: The configurations can be found in the Workspace file in the launch/compounds section.*
    This will start several processes, including launching a browser to the specified URL.
    1. In the browser, open the DevTools (F12) if they are not already opened. 
        1. Select the Sources tool and open the Overrides panel. Click *Select folder for overrides* and select a local folder where the browser content will be stored. Update the **BROWSER_OVERRIDE_CONTENT_ROOT** value in the `.env` file from the previous step with this folder path (using forward slashes instead of back slashes as the folder delimter).
        1. Select the Application tool and select *Application > Service workers* on the left. In the panel on the right, check the **Bypass for network** checkbox. This forces the [Service Worker](https://developer.chrome.com/docs/workbox/service-worker-overview) to re-fetch resources rather than depending on cached copies.
    1. Add the desired script to the Local Overrides.
        1. Navigate to the Dataverse screen (form) where the desired local script file is hosted.
        1. Locate the script in the Sources tool. Right-click the file's name and select *Override content*.

# Unit Tests

Unit Tests live in the `/tests` folder and can be written in TypeScript using the Jasmine test framework. They can be executed using the [Test Explorer UI](https://marketplace.visualstudio.com/items?itemName=hbenl.vscode-test-explorer) and [Jasmine Test Explorer](https://marketplace.visualstudio.com/items?itemName=hbenl.vscode-jasmine-test-adapter) extensions, or by running the `npm test` command.

Code Coverage is generated by [Istanbul](https://istanbul.js.org) / [NYC](https://github.com/istanbuljs/nyc) and can be viewed by opening `/coverage/lcov-report/index.html` in a browser.
